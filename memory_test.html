<script>
    const surveyData = JSON.parse(localStorage.getItem('surveyData')) || {};
    let currentPhase = 0;
    let currentIndex = 0;
    let mediaRecorder;
    let audioStream;
    let audioChunks = [];
    const responses = [];
    const startTestButton = document.getElementById("start-test-button");
    const instructionsDiv = document.getElementById("instructions");
    const phaseContentDiv = document.getElementById("phase-content");
    const startPhaseButton = document.getElementById("start-phase-button");
    const nextWordButton = document.getElementById("next-word-button");

    const phases = [
        { instructions: "Read aloud! This will help you memorize them better！", content: ["pit", "pat", "pot", "tip", "tap", "top"], record: true },
        { instructions: "Follow the audio! He/She is willing to enhance your memory!", content: ["pit", "pat", "pot", "tip", "tap", "top"], audio: true, record: true },
        { instructions: "Memory test! Have you seen this word?", content: ["cat", "tip", "cop", "pick", "pat"], test: true },
    ];

    const versionPaths = {
        1: "audio/1/word",
        2: "audio/2/word",
        3: "audio/3/word",
        4: "audio/4/word",
    };

    let randomVersion;
    const versionCounts = JSON.parse(localStorage.getItem('versionCounts')) || { 1: 0, 2: 0, 3: 0, 4: 0 };

    function selectVersion() {
        randomVersion = Object.keys(versionCounts).reduce((a, b) => versionCounts[a] < versionCounts[b] ? a : b);
        versionCounts[randomVersion]++;
        localStorage.setItem('versionCounts', JSON.stringify(versionCounts));
    }

    const audioElements = {};

    function preloadAudio() {
        const progressSection = document.getElementById('progress-section');
        const progressBar = document.getElementById('progress-bar');
        progressSection.style.display = "block";
        startTestButton.style.display = "none"; // Hide the "Start Test" button during loading

        const phase2 = phases[1];
        const totalFiles = phase2.content.length;

        let loadedCount = 0;
        let hasError = false;

        phase2.content.forEach((word) => {
            const audio = new Audio(`${versionPaths[randomVersion]}/${word}.mp3`);

            audio.onloadeddata = () => {
                if (hasError) return;
                loadedCount++;
                progressBar.style.width = `${(loadedCount / totalFiles) * 100}%`;
                if (loadedCount === totalFiles) {
                    finalizePreload();
                }
            };

            audio.onerror = () => {
                hasError = true;
                console.error(`Failed to load ${word}. Continuing...`);
                loadedCount++;
                progressBar.style.width = `${(loadedCount / totalFiles) * 100}%`;
                if (loadedCount === totalFiles) {
                    finalizePreload();
                }
            };

            audioElements[word] = audio;
        });

        function finalizePreload() {
            progressSection.style.display = "none";
            startTestButton.style.display = "block"; // Show the "Start Test" button after loading
        }
    }

    function getRespondentId() {
        let respondentId = localStorage.getItem("respondentId");
        if (!respondentId) {
            respondentId = "resp_" + Date.now();
            localStorage.setItem("respondentId", respondentId);
        }
        return respondentId;
    }

    async function initializeMicrophone() {
        try {
            audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(audioStream);
            console.log("Microphone initialized.");
        } catch (error) {
            alert("Microphone access failed: " + error.message);
        }
    }

    let isTestInitialized = false;

    function initializeTest() {
        if (isTestInitialized) return; // Prevent re-initialization

        isTestInitialized = true;
        selectVersion();
        preloadAudio();
        initializeMicrophone();
    }

    function renderInstructions() {
        const phase = phases[currentPhase];
        instructionsDiv.textContent = phase.instructions;
        instructionsDiv.style.display = "block";
        phaseContentDiv.style.display = "none";
        startPhaseButton.style.display = "block";
        nextWordButton.style.display = "none";
        nextWordButton.disabled = true;

        currentIndex = 0;
    }

    startTestButton.addEventListener("click", () => {
        initializeTest();
    });

    startPhaseButton.addEventListener("click", () => {
        instructionsDiv.style.display = "none";
        startPhaseButton.style.display = "none";
        renderWord();
    });

    function renderWord() {
        const phase = phases[currentPhase];
        const word = phase.content[currentIndex];
        phaseContentDiv.innerHTML = "";
        phaseContentDiv.style.display = "block";

        if (phase.audio) {
            const audio = audioElements[word];
            audio.controls = true;
            phaseContentDiv.appendChild(audio);

            audio.onended = () => {
                const recordButton = document.createElement("button");
                recordButton.id = "record-button";
                recordButton.textContent = "Start Recording";
                recordButton.onclick = () => toggleRecording(word, recordButton);
                phaseContentDiv.appendChild(recordButton);
            };
            audio.play();
        } 
        else if (phase.record) {
            const wordDiv = document.createElement("div");
            wordDiv.className = "word";
            wordDiv.textContent = word;
            phaseContentDiv.appendChild(wordDiv);

            const recordButton = document.createElement("button");
            recordButton.textContent = "Start Recording";
            recordButton.onclick = () => toggleRecording(word, recordButton);
            phaseContentDiv.appendChild(recordButton);
        }
        else if (phase.test) {
            const wordDiv = document.createElement("div");
            wordDiv.className = "word";
            wordDiv.textContent = word;
            phaseContentDiv.appendChild(wordDiv);

            const yesButton = document.createElement("button");
            yesButton.textContent = "Yes";
            yesButton.onclick = nextWord;

            const noButton = document.createElement("button");
            noButton.textContent = "No";
            noButton.onclick = nextWord;

            phaseContentDiv.appendChild(yesButton);
            phaseContentDiv.appendChild(noButton);
        }

        nextWordButton.style.display = "none";
        nextWordButton.disabled = true;
    }

    function toggleRecording(word, button) {
        if (mediaRecorder) {
            if (mediaRecorder.state === "inactive") {
                audioChunks = [];
                mediaRecorder.ondataavailable = event => audioChunks.push(event.data);

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/mpeg' });
                    const respondentId = getRespondentId();

                    const { grade, "preferred-accent": accent, gender, "learning-start": startAge, languages, dialects } = surveyData;
                    const folderPath = `${grade}_${accent}_${gender}_${startAge}_${languages}_${dialects}/`;

                    const phaseFolder = `phase${currentPhase + 1}`;  
                    const fileName = `${folderPath}${phaseFolder}/${word}_${Date.now()}.mp3`;

                    const client = new OSS({
                        region: 'oss-rg-china-mainland',
                        accessKeyId: 'LTAI5tMVY9Jpm2MroinSie5z',
                        accessKeySecret: 'BU384EPr4lgFxnBEgwx041JaqSFts6',
                        bucket: 'linguisticstest',
                    });

                    try {
                        const result = await client.put(fileName, audioBlob);
                        console.log(`Uploaded to OSS: ${result.url}`);
                        responses.push({ word, responseUrl: result.url });
                    } catch (error) {
                        console.error("Error uploading file to OSS:", error);
                    }
                };

                mediaRecorder.start();
                button.textContent = "Stop Recording";
            } else {
                mediaRecorder.stop();
                button.textContent = "Recording... Please Wait";
                button.disabled = true;
            }
        }
    }

    function nextWord() {
        currentIndex++;
        if (currentIndex < phases[currentPhase].content.length) {
            renderWord();
        } else {
            if (currentPhase < phases.length - 1) {
                currentPhase++;
                renderInstructions();
            } else {
                endTest();
            }
        }
    }

    function endTest() {
        phaseContentDiv.innerHTML = "<p>Thank you for participating in the test!</p>";
        phaseContentDiv.style.display = "block";
        nextWordButton.style.display = "none";
    }
</script>
