<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey</title>
    <style>
        /* Your existing styles */
    </style>
</head>
<body>
    <div class="container">
        <h1>Survey</h1>
        <p>Please fill in your information to proceed:</p>
        <form id="survey-form">
            <div class="form-field">
                <label for="grade">Grade:</label>
                <input type="text" id="grade" name="grade" placeholder="e.g., 大一、大二" required>
            </div>
            <div class="form-field">
                <label for="preferred-accent">Preferred Accent:</label>
                <select id="preferred-accent" name="preferred-accent" required>
                    <option value="American">American</option>
                    <option value="British">British</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-field">
                <label for="gender">Gender:</label>
                <select id="gender" name="gender" required>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Non-binary">Non-binary</option>
                    <option value="Prefer not to say">Prefer not to say</option>
                </select>
            </div>
            <div class="form-field">
                <label for="learning-start">When did you start learning English? :</label>
                <input type="number" id="learning-start" name="learning-start" placeholder="Please type in the age you started." required>
            </div>
            <div class="form-field">
                <label for="languages">Languages You Use:</label>
                <input type="text" id="languages" name="languages" placeholder="e.g., English, Spanish" required>
            </div>
            <div class="form-field">
                <label for="dialects">Dialects You Use:</label>
                <input type="text" id="dialects" name="dialects" placeholder="e.g., 武汉话，红安话，粤语" required>
            </div>
            <button type="submit">Start Test</button>
        </form>
    </div>

    <!-- Load the Aliyun OSS SDK -->
    <script src="https://gosspublic.alicdn.com/aliyun-oss-sdk-6.0.2.min.js"></script>

    <script>
        window.onload = function() {
            // Check if OSS SDK is loaded
            if (typeof OSS !== 'undefined') {
                console.log('OSS SDK loaded successfully');
            } else {
                console.error('OSS SDK failed to load');
            }

            // Handle the survey form submission
            document.getElementById('survey-form').addEventListener('submit', async (event) => {
                event.preventDefault(); // Prevent page refresh

                const formData = new FormData(event.target);
                const surveyData = {};

                formData.forEach((value, key) => {
                    surveyData[key] = value;
                });

                // Store survey data in localStorage (for passing to the memory test page)
                localStorage.setItem('surveyData', JSON.stringify(surveyData));

                // Prepare CSV data for upload
                const csvData = convertToCSV(surveyData);

                // Create a respondent ID if it doesn't exist in localStorage
                let respondentId = localStorage.getItem("respondentId");
                if (!respondentId) {
                    respondentId = "resp_" + Date.now(); // Unique respondent ID
                    localStorage.setItem("respondentId", respondentId);
                }

                // Define the survey file name and path
                const surveyVersion = Math.floor(Math.random() * 4) + 1; // Random version
                const surveyFileName = `${respondentId}/survey/survey_version_${surveyVersion}.csv`;

                // Initialize OSS client
                const client = new OSS({
                    region: 'oss-rg-china-mainland',  // Use your own region
                    accessKeyId: 'your-access-key',   // Use your own access key
                    accessKeySecret: 'your-access-secret',  // Use your own access secret
                    bucket: 'linguisticstest'  // Your OSS bucket name
                });

                try {
                    // Upload CSV data to OSS
                    const result = await client.put(surveyFileName, new Blob([csvData], { type: 'text/csv' }));
                    console.log(`Survey data uploaded successfully: ${result.url}`);
                } catch (error) {
                    console.error('Error uploading survey data:', error);
                }

                // Redirect to memory test page
                window.location.href = 'memory_test.html';
            });
        };

        // Function to convert survey data to CSV format
        function convertToCSV(data) {
            const csv = Object.keys(data)
                .map(key => `${key},${data[key]}`)
                .join('\n');
            return csv;
        }
    </script>
</body>
</html>
